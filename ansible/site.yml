---
- name: Configuration de l'infrastructure
  hosts: all
  gather_facts: no # On ne peut pas gather facts si SSH n'est pas prÃªt !
  tasks:
    - name: Attendre que les VMs soient joignables en SSH
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 300 # On attend jusqu'Ã  5 minutes si besoin
  become: yes
  roles:
    - common

- name: Configuration Web
  hosts: webservers
  become: yes
  roles:
    - web

- name: Configuration DB
  hosts: dbservers
  become: yes
  roles:
    - db

- name: ğŸ RÃ©capitulatif final de l'infrastructure
  hosts: webservers
  gather_facts: no  # Pas besoin de perdre du temps Ã  regÃ©nÃ©rer les facts
  tasks:
    - name: "Affichage des accÃ¨s de {{ env_label }}"
      ansible.builtin.debug:
        msg:
          - "###############################################################"
          - "#      DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS ({{ env_label }})         "
          - "###############################################################"
          - ""
          - "  ğŸŒ URL DU SERVEUR WEB : https://{{ ansible_host }}"
          - "  ğŸ’¬ MESSAGE : {{ welcome_message }}"
          - "  ğŸ›¡ï¸  SÃ‰CURITÃ‰ : HTTPS actif & Firewall configurÃ©"
          - "  ğŸ’¾ BACKUP : Cron job activÃ© sur la base de donnÃ©es"
          - ""
          - "  Le serveur est prÃªt pour la production !"
          - "###############################################################"
